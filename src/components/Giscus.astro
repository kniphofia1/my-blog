---
// Giscus 评论组件
// 使用说明：
// 1. 访问 https://giscus.app/ 生成配置
// 2. 输入你的 GitHub 仓库: kniphofia1/my-blog
// 3. 启用 GitHub Discussions
// 4. 选择讨论分类
// 5. 复制生成的 data-repo-id 和 data-category-id
// 6. 在下方配置中替换这些值

interface Props {
	lang?: string;
}

const { lang = 'zh-CN' } = Astro.props;
---

<div class="giscus-container">
	<script src="https://giscus.app/client.js"
		data-repo="kniphofia1/my-blog"
		data-repo-id="R_kgDOQxxxxx"
		data-category="Announcements"
		data-category-id="DIC_kwDOQxxxxx"
		data-mapping="pathname"
		data-strict="0"
		data-reactions-enabled="1"
		data-emit-metadata="0"
		data-input-position="bottom"
		data-theme="preferred_color_scheme"
		data-lang={lang}
		crossorigin="anonymous"
		async>
	</script>
</div>

<style>
	.giscus-container {
		margin-top: 3rem;
		padding-top: 2rem;
		border-top: 2px solid var(--border-color);
	}

	/* 确保 Giscus 在暗色模式下正常工作 */
	[data-theme='dark'] .giscus-container {
		--color-text-primary: rgb(241, 245, 249);
		--color-bg-primary: rgb(15, 23, 42);
	}

	/* 调整 Giscus 宽度以适应文章内容 */
	.giscus-container :global(.giscus-frame) {
		width: 100%;
	}
</style>

<script>
	// 监听主题变化，更新 Giscus 主题
	function updateGiscusTheme(theme: string) {
		const giscusFrame = document.querySelector('.giscus-frame') as HTMLIFrameElement;
		if (!giscusFrame) return;

		const giscusTheme = theme === 'dark' ? 'dark' : 'light';
		giscusFrame.contentWindow?.postMessage(
			{ giscus: { setConfig: { theme: giscusTheme } } },
			'https://giscus.app'
		);
	}

	// 初始化主题
	function initGiscusTheme() {
		const html = document.documentElement;
		const currentTheme = html.getAttribute('data-theme') || 'light';
		updateGiscusTheme(currentTheme);

		// 监听主题变化
		const observer = new MutationObserver((mutations) => {
			mutations.forEach((mutation) => {
				if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
					const newTheme = html.getAttribute('data-theme') || 'light';
					updateGiscusTheme(newTheme);
				}
			});
		});

		observer.observe(html, {
			attributes: true,
			attributeFilter: ['data-theme']
		});
	}

	// 页面加载后初始化
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initGiscusTheme);
	} else {
		initGiscusTheme();
	}
</script>
