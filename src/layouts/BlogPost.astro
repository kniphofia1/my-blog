---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import BackToTop from '../components/BackToTop.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Giscus from '../components/Giscus.astro';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage, tags } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
			}
			.prose {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: rgb(var(--gray-dark));
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
			}
			.date {
				margin-bottom: 0.5em;
				color: rgb(var(--gray));
			}
			.last-updated-on {
				font-style: italic;
			}

			/* 代码块包装器样式 */
			.code-block-wrapper {
				position: relative;
				margin: 1.5em 0;
			}

			/* 复制按钮样式 */
			.copy-button {
				position: absolute;
				top: 0.5rem;
				right: 0.5rem;
				background: var(--accent-color);
				color: white;
				border: none;
				border-radius: 6px;
				padding: 0.4rem 0.8rem;
				font-size: 0.85rem;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 0.3rem;
				font-family: inherit;
				z-index: 10;
			}

			.copy-button:hover {
				background: var(--accent-dark);
				transform: translateY(-1px);
			}

			.copy-button:active {
				transform: translateY(0);
			}

			.copy-button.copied {
				background: #10b981;
			}

			.copy-button svg {
				width: 16px;
				height: 16px;
			}

			/* 暗色模式下的代码块样式优化 */
			[data-theme='dark'] .copy-button {
				background: var(--accent-color);
			}

			[data-theme='dark'] .copy-button:hover {
				background: var(--accent-dark);
			}

			/* 文章标签样式 */
			.post-tags {
				display: flex;
				gap: 0.5rem;
				flex-wrap: wrap;
				margin-top: 1rem;
			}

			.tag {
				display: inline-block;
				padding: 0.3rem 0.8rem;
				background: rgba(var(--gray), 0.1);
				color: var(--accent-color);
				border-radius: 16px;
				font-size: 0.85rem;
				text-decoration: none;
				transition: all 0.2s ease;
				border: 1px solid transparent;
			}

			.tag:hover {
				background: var(--accent-color);
				color: white;
				transform: translateY(-2px);
				box-shadow: 0 2px 8px rgba(var(--gray), 0.2);
			}

			/* 暗色模式标签样式 */
			[data-theme='dark'] .tag {
				background: rgba(99, 102, 241, 0.15);
				border-color: rgba(99, 102, 241, 0.3);
			}

			[data-theme='dark'] .tag:hover {
				background: var(--accent-color);
				border-color: var(--accent-color);
			}
		</style>
	</head>

	<body>
		<ReadingProgress />
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
				</div>
				<div class="prose">
					<div class="title">
						<div class="date">
							<FormattedDate date={pubDate} />
							{
								updatedDate && (
									<div class="last-updated-on">
										Last updated on <FormattedDate date={updatedDate} />
									</div>
								)
							}
						</div>
						<h1>{title}</h1>
						<hr />
						{tags && tags.length > 0 && (
							<div class="post-tags">
								{tags.map((tag) => (
									<a href={`/tags/${tag}/`} class="tag">
										#{tag}
									</a>
								))}
							</div>
						)}
					</div>
					<slot />
					<Giscus />
				</div>
			</article>
		</main>
		<TableOfContents />
		<BackToTop />
		<Footer />

		<!-- 代码块复制功能脚本 -->
		<script define:vars={{ accentColor: '#2337ff' }}>
			// 等待页面加载完成
			function initCodeBlocks() {
				// 获取所有代码块
				const codeBlocks = document.querySelectorAll('pre > code');

				codeBlocks.forEach((codeBlock) => {
					const pre = codeBlock.parentElement;

					// 如果已经有包装器，跳过
					if (pre.parentElement.classList.contains('code-block-wrapper')) {
						return;
					}

					// 创建包装器
					const wrapper = document.createElement('div');
					wrapper.className = 'code-block-wrapper';

					// 将 pre 元素包装
					pre.parentNode.insertBefore(wrapper, pre);
					wrapper.appendChild(pre);

					// 创建复制按钮
					const copyButton = document.createElement('button');
					copyButton.className = 'copy-button';
					copyButton.innerHTML = `
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
						</svg>
						<span>复制</span>
					`;
					copyButton.setAttribute('aria-label', '复制代码');

					// 添加点击事件
					copyButton.addEventListener('click', async () => {
						const code = codeBlock.textContent || codeBlock.innerText;

						try {
							await navigator.clipboard.writeText(code);

							// 显示复制成功状态
							copyButton.classList.add('copied');
							copyButton.innerHTML = `
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
								</svg>
								<span>已复制</span>
							`;

							// 2秒后恢复原状
							setTimeout(() => {
								copyButton.classList.remove('copied');
								copyButton.innerHTML = `
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
									</svg>
									<span>复制</span>
								`;
							}, 2000);
						} catch (err) {
							console.error('复制失败:', err);
							copyButton.textContent = '复制失败';
							setTimeout(() => {
								copyButton.innerHTML = `
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
									</svg>
									<span>复制</span>
								`;
							}, 2000);
						}
					});

					// 将按钮添加到包装器
					wrapper.appendChild(copyButton);
				});
			}

			// 页面加载时初始化
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initCodeBlocks);
			} else {
				initCodeBlocks();
			}
		</script>
	</body>
</html>
